# Development Log (DEVLOG)

## 2025-12-23
### [FEATURE] 键盘快捷键导航支持
- **问题**：在详情预览模式下，用户只能通过点击 UI 按钮进行翻页，操作效率较低。
- **解决办法**：在 `PhotoAlbum.tsx` 中使用 `useEffect` 注册全局 `keydown` 事件监听。
  - `ArrowLeft`: 切换上一张。
  - `ArrowRight`: 切换下一张。
  - `Escape`: 关闭预览。

### [FEATURE] 解决批量下载导致的 Explorer 弹窗卡死问题
- **问题**：全选下载时，浏览器会连续弹出数十个“另存为”对话框，导致系统响应缓慢甚至卡死。
- **解决办法**：
  1. **全额下载 ZIP 化**：后端引入 `archiver` 库，新增 `/api/album/:albumId/zip` 接口，将整个相册打包成单个 ZIP 文件下载。
  2. **本地路径静默保存**：
     - 在首页增加“下载设置”，允许用户配置本地路径（缺省为 `~/Downloads/frame-catcher-output`）。
     - 后端新增 `/api/download/local` 接口，直接将文件从服务器目录复制到指定的本地物理路径，彻底避开浏览器下载弹窗。
     - 前端 `downloadBatch` 和 `downloadSingle` 优先检测并使用该本地路径。

### [FIX] 相册重启后显示“相册不存在”的问题
- **问题**：应用重启后访问之前的相册 URL 提示 404。
- **原因**：`LocalPgAdapter` 在数据库连接失败时静默返回了 `null`，导致路由误判为记录不存在。
- **解决办法**：在 `LocalPgAdapter.getTask` 中添加详细的错误日志捕获，并确保后端能正确区分“数据库异常”与“数据不存在”。

### [OPTIMIZE] 详情预览页 UI 对齐与适配
- **问题**：预览图与下方的工具栏（Toolbar）宽度不一致，视觉上错位。
- **解决办法**：
  - 重构容器布局，使用 `w-fit` 和 `max-w` 约束。
  - 针对不同分辨率的帧图片进行动态适配：低分辨率图片缩小以匹配工具栏最小宽度，高分辨率图片则撑大工具栏直至达到上限。

### [FEATURE] 命名方式选项与时间戳计算
- **问题**：用户需要根据不同需求重命名导出的图片。
- **解决办法**：
  - 在相册页增加“命名模式”切换：
    1. **帧号模式**：`frame_X_of_Y.heic`
    2. **时间戳模式**：`HH-mm-ss-SSS.heic`
  - 前端根据 FPS（默认 30）自动计算每帧对应的视频时间戳。

### [FEATURE] 批量勾选与单张下载功能
- **问题**：原有功能仅支持下载整个相册。
- **解决办法**：
  - 为瀑布流中的每张照片添加悬浮复选框。
  - 增加“全选”和“批量下载 (N)”按钮。
  - 在详情预览页增加“下载当前帧”按钮。

### [FIX] 预览详情页图片无法加载
- **问题**：点击进入详情页后显示“无法加载图片”灰色占位符。
- **原因**：前端 `getImageUrl` 路径拼接逻辑错误（重复添加 `albums/` 或斜杠处理不当），且后端缺少 `/api/albums` 静态资源路由。
- **解决办法**：重构路径规格化函数，并在 `api/app.ts` 中增加 `/api/albums` 的静态文件服务。

### [FIX] 进度条跳动与重复写入
- **问题**：上传/处理过程中进度条在 0% 和当前进度之间剧烈跳动。
- **原因**：数据库写入频率过高且存在无序更新。
- **解决办法**：在 `upload.ts` 中实现 500ms 的节流（Throttling）机制，并增加进度值单调递增校验。
